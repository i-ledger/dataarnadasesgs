<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Laporan Maintenance - iArmada</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="config.js"></script>
</head>
<body class="bg-gray-100">
  <div class="p-4">
    <h1 class="text-2xl font-bold mb-4">Laporan Maintenance Armada</h1>
    <form id="maintenanceForm" class="bg-white p-4 rounded shadow">
      <select id="armada" class="border p-2 w-full mb-2" required></select>
      <select id="jenis" class="border p-2 w-full mb-2">
        <option value="Ganti Oli">Ganti Oli</option>
        <option value="Service">Service</option>
        <option value="Ganti Ban">Ganti Ban</option>
        <option value="Ganti Kopling">Ganti Kopling</option>
        <option value="Perpanjang STNK">Perpanjang STNK</option>
        <option value="Pajak Tahunan">Pajak Tahunan</option>
        <option value="KIR">KIR</option>
      </select>
      <input type="date" id="tanggal" class="border p-2 w-full mb-2" required />
      <textarea id="keterangan" placeholder="Keterangan" class="border p-2 w-full mb-2"></textarea>
      <input type="file" id="foto" accept="image/*" class="mb-2" />
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Simpan</button>
    </form>

    <table class="mt-4 w-full bg-white rounded shadow">
      <thead><tr class="bg-blue-100"><th>Tanggal</th><th>Armada</th><th>Jenis</th><th>Keterangan</th><th>Foto</th><th>Aksi</th></tr></thead>
      <tbody id="maintenanceTable"></tbody>
    </table>
  </div>

  <script>
    async function loadArmada(){
      const res = await fetch(`${API_URL}?action=getArmada`);
      const data = await res.json();
      armada.innerHTML = data.map(a => `<option value='${a.nomor}'>${a.nomor} - ${a.driver}</option>`).join('');
    }

    async function loadMaintenance(){
      const res = await fetch(`${API_URL}?action=getMaintenance`);
      const data = await res.json();
      maintenanceTable.innerHTML = data.map(d => `
        <tr>
          <td>${d.tanggal}</td><td>${d.armada}</td><td>${d.jenis}</td>
          <td>${d.keterangan||''}</td>
          <td>${d.foto?`<img src='${d.foto}' class='w-16 h-16 object-cover'/>`:''}</td>
          <td><button onclick="hapus('${d.id}')" class='text-red-600'>Hapus</button></td>
        </tr>`).join('');
    }

    async function hapus(id){
      if(confirm('Hapus laporan ini?')){
        await fetch(API_URL, {method:'POST', body:JSON.stringify({action:'delMaintenance', id})});
        loadMaintenance();
      }
    }

    document.getElementById('maintenanceForm').addEventListener('submit', async e => {
      e.preventDefault();
      const formData = new FormData();
      formData.append('action', 'addMaintenance');
      formData.append('armada', armada.value);
      formData.append('jenis', jenis.value);
      formData.append('tanggal', tanggal.value);
      formData.append('keterangan', keterangan.value);
      if(foto.files[0]) formData.append('foto', foto.files[0]);

      await fetch(API_URL, {method:'POST', body: formData});
      maintenanceForm.reset(); loadMaintenance();
    });

    loadArmada(); loadMaintenance();
  </script>
</body>
</html>
