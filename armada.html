<!doctype html>
<html>
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Armada</title>
<script>const API_ROOT='PASTE_YOUR_DEPLOYED_WEBAPP_URL';</script>
</head>
<body>
  <h2>Armada</h2>
  <div>
    <form id="addForm">
      <input name="nopol" placeholder="NoPol" required>
      <input name="tipe" placeholder="Tipe">
      <input name="tahun" placeholder="Tahun">
      <select name="driver_id" id="driverSel"><option value="">--Pilih Driver--</option></select>
      <button>Tambah</button>
    </form>
  </div>
  <table border="1" id="tbl"><thead><tr><th>ID</th><th>NoPol</th><th>Tipe</th><th>Tahun</th><th>Driver</th><th>Aksi</th></tr></thead><tbody></tbody></table>
  <script>
    const user = JSON.parse(localStorage.getItem('user')||'null'); if(!user) location.href='index.html';
    async function loadDrivers(){
      const res = await fetch(API_ROOT+`?action=getDrivers&id_pt=${encodeURIComponent(user.id_pt)}`).then(r=>r.json());
      const sel = document.getElementById('driverSel'); sel.innerHTML = '<option value="">--Pilih Driver--</option>';
      res.forEach(d=>{ const opt=document.createElement('option'); opt.value=d.driver_id; opt.text = d.nama_driver; sel.appendChild(opt); });
    }
    async function load(){
      await loadDrivers();
      const res = await fetch(API_ROOT+`?action=getArmada&id_pt=${encodeURIComponent(user.id_pt)}`).then(r=>r.json());
      const tbody = document.querySelector('#tbl tbody'); tbody.innerHTML='';
      res.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${r.id_armada}</td><td>${r.nopol}</td><td>${r.tipe}</td><td>${r.tahun}</td><td>${r.driver_id||''}</td><td><button data-id="${r.id_armada}" class="del">Hapus</button> <button data-id="${r.id_armada}" class="edit">Edit</button></td>`; tbody.appendChild(tr); });
    }
    document.getElementById('addForm').addEventListener('submit', async e=>{
      e.preventDefault(); const f=e.target; const body={action:'addArmada', nopol:f.nopol.value, tipe:f.tipe.value, tahun:f.tahun.value, id_pt:user.id_pt, driver_id:f.driver_id.value};
      const res = await fetch(API_ROOT,{method:'POST',body:JSON.stringify(body)}).then(r=>r.json()); if(res.status==='ok'){ alert('Ditambah'); load(); } else alert('Gagal');
    });
    document.addEventListener('click', async e=>{
      if(e.target.classList.contains('del')){ if(!confirm('Hapus?')) return; const id=e.target.dataset.id; const res=await fetch(API_ROOT,{method:'POST',body:JSON.stringify({action:'deleteArmada',id_armada:id})}).then(r=>r.json()); if(res.status==='ok') load(); else alert('Gagal'); }
      if(e.target.classList.contains('edit')){
        const id = e.target.dataset.id; const nopol = prompt('NoPol baru?'); if(nopol===null) return; const res = await fetch(API_ROOT,{method:'POST',body:JSON.stringify({action:'editArmada', id_armada:id, nopol})}).then(r=>r.json()); if(res.status==='ok') load(); else alert('Gagal'); }
    });
    load();
  </script>
</body>
</html>
